{% extends "base.html" %}
{% block content %}

<div class="calendar-header">
    <img src="{{ url_for('static', filename='img/logo.png') }}" class="calendar-logo">
    <h2 class="calendar-title">{{ month_name }} {{ year }}</h2>
</div>

<div class="calendar-nav">
    <a href="{{ url_for('calendar.index', month=prev_month, year=prev_year) }}" class="btn btn-yellow">
        ← Previous
    </a>
    <a href="{{ url_for('calendar.index', month=next_month, year=next_year) }}" class="btn btn-yellow">
        Next →
    </a>
</div>

{% if session.get("user") %}
<div class="calendar-actions">
    <a href="{{ url_for('job.add_job_for_date', date=today.isoformat()) }}" class="btn btn-yellow">
        + Add Job
    </a>
    <a href="{{ url_for('calendar.add_time_off') }}" class="btn btn-yellow">+ Add Time Off
    </a>
</div>
{% endif %}

<div class="calendar-wrapper">
  <table class="calendar-table">

    <tr>
        {% set dows = ["Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat"] %}
        {% set dows_mobile = ["S", "M", "T", "W", "T", "F", "S"] %}
        {% for dow in dows %}
            <th class="calendar-day-label" data-short="{{ dows_mobile[loop.index0] }}">{{ dow }}</th>
        {% endfor %}
    </tr>

    {% for week in weeks %}
    <tr>
        {% for day in week %}
        {% set day_str = day.isoformat() %}
        {% set is_past = day < today %}
        {% set holiday = holidays.get(day_str) %}
        {% set is_locked = day_str in locks %}

        <td class="calendar-cell
            {% if is_past %}past{% endif %}
            {% if holiday %}holiday{% endif %}
            {% if is_locked %}locked{% endif %}
            {% if day == today %}today{% endif %}">
        <a class="cell-overlay" href="{{ url_for('calendar.day_view', selected_date=day_str) }}" aria-label="Open day view for {{ day_str }}"></a>

            <div class="cell-date">
                <a href="{{ url_for('calendar.day_view', selected_date=day_str) }}" style="text-decoration: none; color: inherit;">
                    {{ day.day }}
                </a>
                {% if holiday %}
                    <span class="holiday-badge">{{ holiday }}</span>
                {% endif %}
            </div>

            {% if is_locked %}
            <div class="locked-msg">FULL</div>
            {% endif %}

            <div class="jobs">
  {# Time Off pills (names only) #}
              {% if time_off_by_date.get(day_str) %}
                {% for tech_name in time_off_by_date[day_str] %}
                  <div class="job-entry off-entry" title="{{ tech_name }} is off">
                    <div class="job-header">
                      <span class="job-tag">OFF</span>
                      {# initials + last name fallback #}
                      {% set parts = (tech_name or '').split() %}
                      {% set short = (parts[0][0] ~ '.' ~ (parts[1] if parts|length>1 else '')) if parts|length>=1 else tech_name %}
                      <span class="job-title">{{ short }}</span>
                    </div>
                  </div>
                {% endfor %}
              {% endif %}

              {# Jobs, sorted by time_range #}
              {% for job in (jobs_by_date.get(day_str, []) | sort(attribute='time_range')) %}
                {% set jt = (job.job_type or job.type or '')|lower %}
                {% if jt in ['rei','reis'] %}
                  {# REI tile #}
                  <div class="job-entry rei-entry" title="Reinspection">
                    <div class="job-header job-info-flex">
                      <div class="job-left">
                        <span class="job-tag">REIs</span>
                        <span class="job-qty">{{ job.rei_quantity or 0 }}</span>
                        {% if job.rei_city_name or job.rei_zip %}
                          <span class="job-city">{{ job.rei_city_name or job.rei_zip }}</span>
                        {% endif %}
                      </div>
                    </div>
                    {% set tech_display = 'Two Men' if job.two_man else (job.technician_name or '') %}
                    {% if tech_display %}
                      <div class="job-footer">
                        <span class="job-title">{{ tech_display }}</span>
                      </div>
                    {% endif %}
                  </div>
                {% else %}
                  {# Generic job tile with multiday continuation markers #}
                  {% set display_name  = job.title or "Unknown" %}
                  {% set price         = job.price %}
                  {% set is_first_day  = (day_str == job.start_date) %}
                  {% set is_last_day   = (day_str == job.end_date) %}
                  {% set is_multi_day  = job.start_date and job.end_date and (job.start_date != job.end_date) %}
                  {% set cont_left     = is_multi_day and not is_first_day %}
                  {% set cont_right    = is_multi_day and not is_last_day %}
                  {% set _display_time = job.time_range if job.time_range and job.time_range != 'any'
                                          else (job.start_time ~ '-' ~ job.end_time if job.start_time and job.end_time else None) %}
                  {% set jtc = jt %}
                  {% set type_abbrv = (type_abbr|default({})).get(jtc, (jtc[:1]|upper) if jtc else '?') %}
                  {% set tech_label = 'Two Men' if job.two_man else (job.technician_name or '') %}

                  <div class="job-entry {% if cont_left %}continues-left{% endif %} {% if cont_right %}continues-right{% endif %}" title="{{ display_name }}">
                    <div class="job-header">
                      {% if _display_time %}<span class="job-time">{{ _display_time }}</span>{% endif %}
                      <span class="job-tag">{{ type_abbrv }}</span>
                      <span class="job-title">{{ display_name }}</span>
                    </div>
                    <div class="job-footer">
                      {% if tech_label %}<span class="job-tech">{{ tech_label }}</span>{% endif %}
                      {% if is_first_day and price not in [None, '', 0] %}
                        <span class="job-price">
                          ${{ ("%0.2f"|format(price|float)).rstrip('0').rstrip('.') }}
                        </span>
                      {% else %}
                        <span class="job-price tbd">TBD</span>
                      {% endif %}
                      {% if cont_left %}<span class="job-arrow job-arrow-left">⟵</span>{% endif %}
                      {% if cont_right %}<span class="job-arrow job-arrow-right">⟶</span>{% endif %}
                    </div>
                  </div>
                {% endif %}
              {% endfor %}
            </div>
        </td>
        {% endfor %}
    </tr>
    {% endfor %}
  </table>
</div>
{% endblock %}

