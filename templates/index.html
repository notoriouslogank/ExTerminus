{% extends "base.html" %}
{% block content %}

<div class="calendar-header">
    <img src="{{ url_for('static', filename='img/logo.png') }}" class="calendar-logo">
    <h2 class="calendar-title">{{ month_name }} {{ year }}</h2>
</div>

<div class="calendar-nav">
    <a href="{{ url_for('calendar.index', month=prev_month, year=prev_year) }}" class="btn btn-yellow">
        ← Previous
    </a>
    <a href="{{ url_for('calendar.index', month=next_month, year=next_year) }}" class="btn btn-yellow">
        Next →
    </a>
</div>

{% if session.get("user") %}
<div class="calendar-actions">
    <a href="{{ url_for('job.add_job', date=today.isoformat()) }}" class="btn btn-yellow">
        + Add Job
    </a>
    <a href="{{ url_for('calendar.add_time_off') }}" class="btn btn-yellow">+ Add Time Off
    </a>
</div>
{% endif %}

<div class="calendar-wrapper">
  <table class="calendar-table">
    <tr>
        {% for dow in ["Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat"] %}
        <th class="calendar-day-label">{{ dow }}</th>
        {% endfor %}
    </tr>

    {% for week in weeks %}
    <tr>
        {% for day in week %}
        {% set day_str = day.isoformat() %}
        {% set is_past = day < today %}
        {% set holiday = holidays.get(day_str) %}
        {% set is_locked = day_str in locks %}

        <td class="calendar-cell
            {% if is_past %}past{% endif %}
            {% if holiday %}holiday{% endif %}
            {% if is_locked %}locked{% endif %}
            {% if day == today %}today{% endif %}">
        <a class="cell-overlay" href="{{ url_for('calendar.day_view', selected_date=day_str) }}" aria-label="Open day view for {{ day_str }}"></a>

            <div class="cell-date">
                <a href="{{ url_for('calendar.day_view', selected_date=day_str) }}" style="text-decoration: none; color: inherit;">
                    {{ day.day }}
                </a>
                {% if holiday %}
                    <span class="holiday-badge">{{ holiday }}</span>
                {% endif %}
            </div>

            {% if is_locked %}
            <div class="locked-msg">FULL</div>
            {% endif %}

            <div class="jobs">
                {% if time_off_by_date.get(day_str) %}
                    {% for tech_name in time_off_by_date[day_str] %}

                    <div class="job-entry off-entry" title="{{ tech_name }} is off">
                        <div class="job-header">
                            <span class="job-tag">OFF</span>
                            <span class="job-title">{{ tech_name.split()[0][0] }}.{{ tech_name.split()[1] }}</span>
                        </div>
                    </div>

                    {% endfor %}
                {% endif %}
                    {% for job in (jobs_by_date.get(day_str, []) | sort
                    (attribute='time_range')) %}
                    {# BUG-1006: template expects 'rei' but code uses 'reis'. Normalize: #}
                    {% set job_type_clean = (job.type or job.job_type or "")|lower|trim %}
                    {% if job_type_clean in ["rei","reis"] %}
                    {% set tech_parts = (job.technician_name or "").split(" ") %}
                    {% set tech_display = tech_parts[0][0] ~ "." ~ tech_parts[1] if tech_parts | length > 1 else job.technician_name %}

                    <div class="job-entry rei-entry" title="Reinspection">
                        <div class="job-header job-info-flex">
                            <div class="job-left">
                                <span class="job-tag">REIs</span>
                                <span class="job-qty">{{ job.rei_quantity }}</span>
                                {% if job.rei_city_name or job.rei_zip %}
                                    <span class="job-city">{{ job.rei_city_name or job.rei_zip }}</span>
                                {% endif %}
                            </div>
                        </div>

                        {% if tech_display %}
                        <div class="job-footer">
                            <span class="job-title">{{ tech_display }}</span>
                        </div>
                        {% endif %}
                    </div>

                    {# removed stray </div> that prematurely closed jobs-wrapper #}
                    {% else %}
                        {% set job_type_clean = (job.type or "")|lower|trim %}
                        {% set type_abbrv = (type_abbr|default).get(job_type_clean, (job_type_clean[:1])|upper) %}
                        {% set display_name = job.title or "Unknown" %}
                        {% set price = job.price %}
                        {% set is_first_day = day_str == job.start_date %}
                        {% set is_multi_day = job.start_date != job.end_date %}
                        {% set show_arrow = is_multi_day and is_first_day %}
                        {% set show_price = is_first_day %}

                    <div class="job-entry" title="{{ display_name }}">
                        <div class="job-header">
                            {% set _display_time = job.time_range if job.time_range and job.time_range != 'any'
                                else (job.start_time ~ '-' ~ job.end_time if job.start_time and job.end_time else None) %}
                            {% if _display_time %}
                                <span class="job-time">{{ _display_time }}</span>
                            {% endif %}
                            <span class="job-tag">{{ type_abbrv }}</span>
                            <span class="job-title">{{ display_name }}</span>
                        </div>
                        <div class="job-footer">
                            {% if show_price and price not in [None, '', 0] %}
                                <span class="job-price">${{ ("%0.2f"|format(price|float)).rstrip('0').rstrip('.') }}</span>
                            {% else %}
                                <span class="job-price tbd">TBD</span>
                            {% endif %}
                            {% if show_arrow %}
                                <span class="job-arrow">→</span>
                            {% endif %}
                        </div>
                    </div>
                    {% endif %}
                {% endfor %}
            </div>
        </td>
        {% endfor %}
    </tr>
    {% endfor %}
  </table>
</div>
{% endblock %}

